#!/usr/bin/python


from __future__ import print_function
import base64, HTMLParser, httplib, json, sys, urllib, zlib
from unidecode import unidecode
from Adafruit_Thermal import *
from pymongo import MongoClient


# Other globals.  You probably won't need to change these. -----------------

printer   = Adafruit_Thermal("/dev/ttyAMA0", 19200, timeout=5)
agent     = 'Gutenbird v1.0'
mongosite = 'mongodb://pedidos:Tias08MatIgo11Rod@c736.candidate.15.mongolayer.com:10736/pedidos'


# lastID is command line value (if passed), else 1
if len(sys.argv) > 1: lastId = sys.argv[1]
else:                 lastId = '1'



# Mainline

#print ('inicia conneccion')

connection = MongoClient(mongosite)

#print (connection)
db = connection.pedidos
pedidosDB = db.pedidos

#try:
pedidos = pedidosDB.find({'estatus':'Enviado a tienda'})
#except:
#print('* error al insertar carga inicial *')


#print('conneccion cerrada')
  




# Display results. ---------------------------------------------------------



for pedido in pedidos:
  print(pedido)
  printer.inverseOn()
  printer.print(' ' + '{:<31}'.format(pedido['nombre']))
  printer.inverseOff()
  printer.print(' ' + '{:<31}'.format(pedido['telefono']))

  printer.underlineOn()
  printer.print('{:<32}'.format(str(pedido['total'])))
  printer.underlineOff()

  
  # Remove HTML escape sequences
  # and remap Unicode values to nearest ASCII equivalents

  for item in pedido['pedido']:
    for detalle in item.values():
      printer.print(unidecode(
        HTMLParser.HTMLParser().unescape(detalle)))


  printer.feed(3)

  check = pedidosDB.update({'_id': pedido['_id']}, {'$set':{'estatus': 'En tienda'}})


connection.close()
